#!/usr/bin/env bash
# Kanata start helper script
# Starts kanata via LaunchDaemon

set -e

CONFIG_FILE="{{ kanata_config_file }}"
LAUNCHD_PLIST="{{ kanata_launchd_plist }}"

echo "Starting Kanata..."
echo "Config: $CONFIG_FILE"

# Check if already running
if pgrep -f "kanata" > /dev/null; then
    echo "⚠️  Kanata is already running"
    ps aux | grep kanata | grep -v grep
    exit 0
fi

# Load the LaunchDaemon
if [ -f "$LAUNCHD_PLIST" ]; then
    echo "Loading LaunchDaemon..."
    sudo launchctl load -w "$LAUNCHD_PLIST"
    sleep 1
    
    if pgrep -f "kanata" > /dev/null; then
        echo "✅ Kanata started via LaunchDaemon"
        ps aux | grep kanata | grep -v grep
    else
        echo "❌ Failed to start Kanata. Check logs:"
        echo "   tail -f /tmp/kanata.err.log"
        exit 1
    fi
else
    echo "❌ LaunchDaemon plist not found: $LAUNCHD_PLIST"
    exit 1
fi
